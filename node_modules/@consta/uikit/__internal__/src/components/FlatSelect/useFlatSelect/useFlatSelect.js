import _asyncToGenerator from"@babel/runtime/helpers/asyncToGenerator";import _slicedToArray from"@babel/runtime/helpers/slicedToArray";import _toConsumableArray from"@babel/runtime/helpers/toConsumableArray";function _createForOfIteratorHelper(a,b){var c="undefined"!=typeof Symbol&&a[Symbol.iterator]||a["@@iterator"];if(!c){if(Array.isArray(a)||(c=_unsupportedIterableToArray(a))||b&&a&&"number"==typeof a.length){c&&(a=c);var d=0,e=function(){};return{s:e,n:function n(){return d>=a.length?{done:!0}:{done:!1,value:a[d++]}},e:function(a){function b(){return a.apply(this,arguments)}return b.toString=function(){return a.toString()},b}(function(a){throw a}),f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var f,g=!0,h=!1;return{s:function s(){c=c.call(a)},n:function n(){var a=c.next();return g=a.done,a},e:function(a){function b(){return a.apply(this,arguments)}return b.toString=function(){return a.toString()},b}(function(a){h=!0,f=a}),f:function f(){try{g||null==c["return"]||c["return"]()}finally{if(h)throw f}}}}function _unsupportedIterableToArray(a,b){if(a){if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);return"Object"===c&&a.constructor&&(c=a.constructor.name),"Map"===c||"Set"===c?Array.from(a):"Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c)?_arrayLikeToArray(a,b):void 0}}function _arrayLikeToArray(a,b){(null==b||b>a.length)&&(b=a.length);for(var c=0,d=Array(b);c<b;c++)d[c]=a[c];return d}import _regeneratorRuntime from"@babel/runtime/regenerator";import{action,sleep,withConcurrency}from"@reatom/framework";import{useAction,useAtom,useUpdate}from"@reatom/npm-react";import{useRef}from"react";import{useRefs}from"../../../hooks/useRefs";import{animateTimeout}from"../../../mixs/MixPopoverAnimate";import{getGroups}from"../../../utils/getGroups";import{useClickOutsideAtom}from"../../../utils/state/useClickOutsideAtom";import{useCreateAtom}from"../../../utils/state/useCreateAtom";import{useElementAtomEventListener}from"../../../utils/state/useElementAtomEventListener";import{useKeysAtom}from"../../../utils/state/useKeysAtom";import{usePickAtom,usePropAtom}from"../../../utils/state/usePickAtom";import{useRefAtom}from"../../../utils/state/useRefAtom";import{scrollToIndex}from"./helpers";var isMultipleParams=function(a){return!!a.multiple};export var isOptionForCreate=function(a){return a&&Object.prototype.hasOwnProperty.call(a,"__optionForCreate")};export var isNotOptionForCreate=function(a){return a&&!Object.prototype.hasOwnProperty.call(a,"__optionForCreate")};export var isOptionForSelectAll=function(a){return a&&Object.prototype.hasOwnProperty.call(a,"__optionSelectAll")};export function getCountedGroups(a,b){var c=_toConsumableArray(a);return b&&a.forEach(function(a,b){c[b].items=[{__optionSelectAll:!0,groupKey:a.key}].concat(_toConsumableArray(c[b].items))}),c}export var useFlatSelect=function(a){var b=a.propsAtom,c=useRef(null),d=useRef(null),f=usePropAtom(b,"anchorRef"),g=useCreateAtom(function(a){var b=a.spy(f);return null!==b&&void 0!==b&&b.current?b.current:null}),h=useRefAtom(),i=_slicedToArray(h,2),j=i[0],k=i[1],l=useCreateAtom(!1),m=useCreateAtom(!1),n=usePropAtom(b,"items"),o=usePropAtom(b,"selectAll"),p=usePropAtom(b,"value"),q=usePropAtom(b,"disabled"),r=useCreateAtom(function(a){return!!a.spy(q)}),s=usePropAtom(b,"inputValue"),t=usePropAtom(b,"isOpen"),u=useCreateAtom(function(a){return!!a.spy(b).onCreate}),v=useCreateAtom(function(a){var c,d=null===(c=a.spy(b).style)||void 0===c?void 0:c.zIndex;return"number"==typeof d?d+1:void 0}),w=usePropAtom(b,"ignoreOutsideClicksRefs"),x=usePropAtom(b,"getItemKey"),y=useCreateAtom(function(a){var b=a.spy(p);return b&&(Array.isArray(b)?b:[b])||[]}),z=useCreateAtom(!1),A=useCreateAtom(!1),B=useCreateAtom(-1),C=useCreateAtom(""),D=useCreateAtom(function(a){var c=a.spy(b),d=c.clearButton,e=a.spy(C),f=a.spy(y);return!!(d&&(null!==f&&void 0!==f&&f.length||e))}),E=useAction(action(function(){var a=_asyncToGenerator(_regeneratorRuntime.mark(function c(a,b){return _regeneratorRuntime.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,a.schedule(function(){return sleep(5)});case 2:l(a,b);case 3:case"end":return c.stop();}},c)}));return function(){return a.apply(this,arguments)}}()).pipe(withConcurrency())),F=useAction(function(a){return m(a,!0)}),G=useAction(function(a){return m(a,!1)}),H=useAction(function(){return E(!0)}),I=useAction(function(){return E(!1)}),J=useAction(function(a){var d,e,f=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"";null===(d=(e=a.get(b)).onInput)||void 0===d?void 0:d.call(e,f),C(a,f),c.current&&(c.current.value=f)}),K=useCreateAtom(function(a){var b=a.spy(u);if(b){var c=a.spy(C);return{label:c,__optionForCreate:!0}}}),L=usePickAtom(b,["selectAll","groups","getItemGroupKey","getGroupKey","getItemKey","items"]),M=useCreateAtom(function(a){var b=a.spy(L),c=b.selectAll,d=b.groups,e=b.getItemGroupKey,f=b.getGroupKey,g=b.items,h=a.spy(K),i=getCountedGroups(getGroups(g,null!==d&&void 0!==d&&d.length?e:void 0,d,f,void 0),c&&g.length&&c);return h?[h].concat(_toConsumableArray(i)):i}),N=useCreateAtom(function(a){var c=a.spy(M),d=a.spy(o),e=a.spy(y),f=a.get(b),g=f.getItemDisabled,h={};return d&&function getFlatSelectedCounter(){var a,b=_createForOfIteratorHelper(c);try{for(b.s();!(a=b.n()).done;){var j=a.value;if(!isOptionForCreate(j)){h[j.key]=[0,j.items.length-1];var d,f=_createForOfIteratorHelper(j.items);try{var i=function(){var a=d.value;isOptionForSelectAll(a)||g(a)||!e.some(function(b){return b===a})||(h[j.key][0]=(h[j.key][0]||0)+1)};for(f.s();!(d=f.n()).done;)i()}catch(a){f.e(a)}finally{f.f()}}}}catch(a){b.e(a)}finally{b.f()}}(),h}),O=useAtom(function(a){var b=a.spy(n),c=a.spy(u),d=a.spy(o),e=a.spy(M);return b.length+(c?1:0)+(d?e.length:0)}),P=_slicedToArray(O,3),Q=P[0],R=P[1],e=P[2],S=useCreateAtom(function(a){var b=a.spy(n),c=a.spy(K);return!!c||!!b.length}),T=useRefs(Q,void 0),U=useAction(function(a){var b=a.get(n),c=a.get(B),e=d.current;0<b.length&&e&&scrollToIndex(c,e,T)}),V=useAction(function(a,b){a.get(r)||B(a,function(c){var d=Math.min(Math.max(0,"function"==typeof b?b(c):b),a.get(e)-1);return d})}),W=useAction(function(a,c,d){c.stopPropagation();var e=a.get(b);if(isMultipleParams(e)){var f=e.getItemDisabled,g=e.getItemKey,h=e.onChange,i=a.get(y).filter(function(a){return!!(null!==f&&void 0!==f&&f(a))||g(a)!==g(d)});h(null!==i&&void 0!==i&&i.length?i:null,{e:c})}}),X=useAction(function(a,c,d){var e=a.get(b),f=e.getItemDisabled,g=e.getItemKey,h=e.onChange,i=e.multiple,j=e.disabled;if(!(j||f&&f(d)))if(i){var k=a.get(y),l=k.some(function(a){return g(a)===g(d)})?k.filter(function(a){return g(a)!==g(d)}):[].concat(_toConsumableArray(k),[d]),m=l.length?l:null;h(m,{e:c})}else h(d,{e:c})}),Y=useAction(function(a,c,d){var e=a.get(y),f=a.get(b),g=f.getItemDisabled,h=f.getItemKey,i=f.multiple,j=f.onChange;if(i){var k=g?d.filter(function(a){return!g(a)}):d,l=[],m=[];if(e.forEach(function(a){k.find(function(b){return h(a)===h(b)})?l.push(a):m.push(a)}),l.length===k.length)j(m.length?m:null,{e:c});else{var n=[].concat(m,_toConsumableArray(k));j(n.length?n:null,{e:c})}}}),Z=useAction(function(a,c){var d=a.get(b),e=d.onCreate;null===e||void 0===e?void 0:e(a.get(C),{e:c}),J("")}),$=useAction(function(a,c){!a.get(r)&&a.get(b).input&&(null===J||void 0===J?void 0:J(c.target.value))}),_=useAction(function(){return J("")}),aa=useAction(function(a,b){return function(a){return W(a,b)}}),ba=useAction(function(a,b){b.preventDefault(),b.stopPropagation(),a.get(r)||(V(function(a){return a-1}),U())}),ca=useAction(function(a,b){b.preventDefault(),b.stopPropagation(),a.get(r)||(V(function(a){return a+1}),U())}),da=useAction(function(a,c){var d=a.get(b),e=d.items,f=a.get(B),g=a.get(C),h=a.get(M);(g||e[f])&&(c.preventDefault(),c.stopPropagation());var i=function getData(a){var b,c=0,d=_createForOfIteratorHelper(h);try{for(d.s();!(b=d.n()).done;){var e=b.value;if(isOptionForCreate(e)){if(c===a)return[void 0,e];c++;continue}if(e.items.length+c>a)return[e,e.items[a-c]];c+=e.items.length}}catch(a){d.e(a)}finally{d.f()}return[void 0,void 0]}(f),j=_slicedToArray(i,2),k=j[0],l=j[1];if(isOptionForCreate(l))return void Z(c);if(isOptionForSelectAll(l)){var m;return void Y(c,null!==(m=null===k||void 0===k?void 0:k.items.filter(function(a){return!isOptionForSelectAll(a)}))&&void 0!==m?m:[])}l&&X(c,l)}),ea=useAction(function(a,b){var c,d;b.preventDefault(),b.stopPropagation(),A(a,!1),null===(c=a.get(f))||void 0===c||null===(d=c.current)||void 0===d?void 0:d.focus()}),fa=useAction(function(a,c){var d,e;a.get(b).input&&!a.get(z)||(a.get(A)&&(c.preventDefault(),c.stopPropagation(),A(a,!1)),null===(d=a.get(f))||void 0===d||null===(e=d.current)||void 0===e?void 0:e.focus())}),ga=useCreateAtom({ArrowUp:ba,ArrowDown:ca,PageUp:ba,PageDown:ca,Home:ba,End:ca,Enter:da,Escape:ea,Tab:fa}),ha=useAction(function(a,b){var c=b.index,d=b.item;if(isOptionForCreate(d))return{onClick:function onClick(a){Z(a),V(c)},onMouseEnter:function onMouseEnter(){return a.get(l)&&V(c)}};if(isOptionForSelectAll(d)){var f=function(){var b,c=a.get(M),e=_createForOfIteratorHelper(c);try{for(e.s();!(b=e.n()).done;){var g=b.value;if(!isOptionForCreate(g)&&g.key===d.groupKey){var f;return null!==(f=null===g||void 0===g?void 0:g.items.filter(function(a){return!isOptionForSelectAll(a)}))&&void 0!==f?f:[]}}}catch(a){e.e(a)}finally{e.f()}return[]};return{onClick:function onClick(a){Y(a,f()),V(c)},onMouseEnter:function onMouseEnter(){return a.get(l)&&V(c)}}}return{onClick:function onClick(a){console.log("onClick",d),V(c),X(a,d)},onMouseEnter:function onMouseEnter(){return a.get(l)&&V(c)}}}),ia=useAction(function(a,c){var d=a.get(b),e=d.disabled,f=d.onInputFocus,g=a.get(z);e||(!g&&z(a,!0),null===f||void 0===f?void 0:f(c))}),ja=useAction(function(a,c){var d,e;a.get(z)&&z(a,!1),null===(d=(e=a.get(b)).onInputBlur)||void 0===d?void 0:d.call(e,c)});useClickOutsideAtom({isActiveAtom:A,ignoreClicksElementsAtom:useCreateAtom(function(a){var b,c=a.spy(j),d=a.spy(g),e=null===(b=a.spy(w))||void 0===b?void 0:b.map(function(a){return a.current});return[c,d].concat(_toConsumableArray(e||[]))}),handler:useAction(function(a){A(a,!1)})}),useClickOutsideAtom({isActiveAtom:l,ignoreClicksElementsAtom:useCreateAtom(function(a){var b=a.spy(j);return[b]}),handler:I}),useUpdate(function(a,b){!b||a.get(m)||-1!==a.get(B)||a.get(r)||B(a,0),b||B(a,-1)},[l]),useUpdate(function(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",c=a.get(C);b!==c&&J(b)},[s]),useUpdate(function(a){var b=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1];return A(a,b)},[t]),useUpdate(function(a){return B(a,-1)},[M]),useUpdate(function(a,b){return b&&B(a,-1)},[r]);var ka=useAction(function(a){return A(a,!a.get(A))});return useElementAtomEventListener(g,"click",ka),useElementAtomEventListener(j,"focus",H),useElementAtomEventListener(j,"click",H),useElementAtomEventListener(j,"blur",I),useElementAtomEventListener(j,"mousedown",F),useElementAtomEventListener(j,"mouseup",G),useKeysAtom({keysAtom:ga,elAtom:j,isActiveAtom:useCreateAtom(function(a){var b;return!!(null!==(b=a.spy(f))&&void 0!==b&&b.current&&a.spy(A))||!a.spy(r)})}),useUpdate(function(){var a=_asyncToGenerator(_regeneratorRuntime.mark(function d(a,c){var e,f,g;return _regeneratorRuntime.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:return null===(e=(f=a.get(b)).onOpen)||void 0===e?void 0:e.call(f,c),d.next=3,sleep(animateTimeout);case 3:if(c){d.next=8;break}return J(""),z(a,!1),l(a,!1),d.abrupt("return");case 8:c&&(null===(g=a.get(j))||void 0===g?void 0:g.focus());case 9:case"end":return d.stop();}},d)}));return function(){return a.apply(this,arguments)}}(),[A]),{openAtom:A,inputFocusAtom:z,inputValueAtom:C,clearButtonAtom:D,onInput:J,getOptionActions:ha,handleInputBlur:ja,getHandleRemoveValue:aa,inputRef:c,listRef:d,handleInputChange:$,handleInputFocus:ia,visibleItemsAtom:M,clearValue:_,optionsRefs:T,highlightedIndexAtom:B,valueAtom:y,getItemKeyAtom:x,onChangeAll:Y,onCreate:Z,onChange:X,hasItemsAtom:S,groupsCounterAtom:N,dropdownZIndexAtom:v,rootRef:k,disabledAtom:r}};
//# sourceMappingURL=useFlatSelect.js.map