{"version":3,"file":"Popover.js","names":["React","forwardRef","useEffect","useLayoutEffect","useMemo","PortalWithTheme","PortalWithThemeConsumer","useTheme","useComponentSize","useForkRef","cn","isRenderProp","isNumber","isString","getComputedPositionAndDirection","getPointPosition","getRenderPosition","usePopoverReposition","directionsStartCenter","directionsStartEdge","popoverPropOffset","directions","getOffset","ref","propOffset","current","cssVar","getComputedStyle","getPropertyValue","test","slice","length","fontSize","parseFloat","document","documentElement","rem","em","cnPopover","Popover","props","componentRef","children","direction","passedDirection","offset","arrowOffset","possibleDirections","isInteractive","onClickOutside","spareDirection","style","className","passedPosition","position","anchorRef","equalAnchorWidth","onSetDirection","viewportRef","container","window","body","otherProps","viewportElement","useRef","theme","useState","anchorClientRect","setAnchorClientRect","width","height","anchorSize","previousDirectionRef","bannedDirections","setBannedDirections","resetBannedDirections","state","updateAnchorClientRect","getBoundingClientRect","contentSize","viewportSize","clientWidth","clientHeight","x","left","y","top","isActive","scrollAnchorRef","onRequestReposition","includes","renderPosition","notVisible"],"sources":["../../../../../src/components/Popover/Popover.tsx"],"sourcesContent":["import './Popover.css';\n\nimport React, { forwardRef, useEffect, useLayoutEffect, useMemo } from 'react';\n\nimport {\n  PortalWithTheme,\n  PortalWithThemeConsumer,\n} from '##/components/PortalWithTheme';\nimport { useTheme } from '##/components/Theme/Theme';\nimport { ClickOutsideHandler } from '##/hooks/useClickOutside';\nimport { useComponentSize } from '##/hooks/useComponentSize';\nimport { useForkRef } from '##/hooks/useForkRef';\nimport { cn } from '##/utils/bem';\nimport { isRenderProp } from '##/utils/isRenderProp';\nimport { isNumber, isString } from '##/utils/type-guards';\nimport { PropsWithJsxAttributes } from '##/utils/types/PropsWithJsxAttributes';\n\nimport {\n  getComputedPositionAndDirection,\n  getPointPosition,\n  getRenderPosition,\n} from './helpers';\nimport { usePopoverReposition } from './usePopoverReposition';\n\n/**\n * Стороны упорядочены по приоритету:\n * Используется первая сторона, в которую смог вписаться поповер.\n */\nexport const directionsStartCenter = [\n  'downCenter',\n  'upCenter',\n\n  'downRight',\n  'downLeft',\n  'upRight',\n  'upLeft',\n\n  'leftUp',\n  'leftCenter',\n  'leftDown',\n\n  'rightUp',\n  'rightCenter',\n  'rightDown',\n] as const;\n\nexport const directionsStartEdge = [\n  'downStartLeft',\n  'upStartLeft',\n\n  'downStartRight',\n  'upStartRight',\n\n  'leftStartUp',\n  'leftStartDown',\n\n  'rightStartUp',\n  'rightStartDown',\n] as const;\n\nexport const popoverPropOffset = [\n  '3xs',\n  '2xs',\n  'xs',\n  's',\n  'm',\n  'l',\n  'xl',\n  '2xl',\n  '3xl',\n  '4xl',\n  '5xl',\n  '6xl',\n] as const;\nexport type PopoverPropOffset = typeof popoverPropOffset[number] | number;\n\nexport const directions = [...directionsStartCenter, ...directionsStartEdge];\n\nexport type Direction = typeof directions[number];\n\nexport type Position = { x: number; y: number } | undefined;\n\nexport type PositioningProps =\n  | {\n      anchorRef: React.RefObject<HTMLElement>;\n      equalAnchorWidth?: boolean;\n      position?: never;\n    }\n  | {\n      anchorRef?: never;\n      equalAnchorWidth?: never;\n      position: Position;\n    };\n\ntype ChildrenRenderProp = (direction: Direction) => React.ReactNode;\n\nexport type PopoverProps = PropsWithJsxAttributes<\n  {\n    direction?: Direction;\n    spareDirection?: Direction;\n    possibleDirections?: Direction[];\n    offset?: PopoverPropOffset;\n    arrowOffset?: number;\n    isInteractive?: boolean;\n    children?: React.ReactNode | ChildrenRenderProp;\n    onClickOutside?: ClickOutsideHandler;\n    onSetDirection?: (direction: Direction) => void;\n    viewportRef?: React.RefObject<HTMLElement>;\n    container?: Element;\n  } & PositioningProps\n>;\n\nexport type Props = PopoverProps; // удалить при мажоре\n\nconst getOffset = (\n  ref: React.RefObject<HTMLDivElement>,\n  propOffset: PopoverPropOffset,\n) => {\n  if (isNumber(propOffset)) {\n    return propOffset;\n  }\n\n  if (isString(propOffset) && ref.current) {\n    const cssVar = getComputedStyle(ref.current).getPropertyValue(\n      `--space-${propOffset}`,\n    );\n\n    if (cssVar && /px$/.test(cssVar)) {\n      return Number(cssVar.slice(0, cssVar.length - 2));\n    }\n\n    if (cssVar && /rem$/.test(cssVar)) {\n      const fontSize = parseFloat(\n        getComputedStyle(document.documentElement).fontSize,\n      );\n      const rem = Number(cssVar.slice(0, cssVar.length - 3));\n\n      return fontSize * rem;\n    }\n\n    if (cssVar && /em$/.test(cssVar)) {\n      const fontSize = parseFloat(getComputedStyle(ref.current).fontSize);\n      const em = Number(cssVar.slice(0, cssVar.length - 2));\n\n      return fontSize * em;\n    }\n\n    return 0;\n  }\n\n  return 0;\n};\n\nconst cnPopover = cn('Popover');\n\nexport const Popover = forwardRef<HTMLDivElement, PopoverProps>(\n  (props, componentRef) => {\n    const {\n      children,\n      direction: passedDirection = 'upCenter',\n      offset: propOffset = 0,\n      arrowOffset,\n      possibleDirections = directions,\n      isInteractive = true,\n      onClickOutside,\n      spareDirection = 'downStartLeft',\n      style,\n      className,\n      position: passedPosition,\n      anchorRef,\n      equalAnchorWidth,\n      onSetDirection,\n      viewportRef,\n      container = window.document.body,\n      ...otherProps\n    } = props;\n\n    const viewportElement = viewportRef?.current || document.documentElement;\n\n    const ref = React.useRef<HTMLDivElement>(null);\n    const { theme } = useTheme();\n\n    const [anchorClientRect, setAnchorClientRect] = React.useState<\n      DOMRect | undefined\n    >();\n    const { width, height } = useComponentSize(ref);\n    const anchorSize = useComponentSize(anchorRef || { current: null });\n    const previousDirectionRef = React.useRef<Direction | null>(null);\n    const [bannedDirections, setBannedDirections] = React.useState<\n      readonly Direction[]\n    >([]);\n\n    const resetBannedDirections = () => {\n      setBannedDirections((state) => (state.length ? [] : state));\n      previousDirectionRef.current = null;\n    };\n\n    const updateAnchorClientRect = () =>\n      setAnchorClientRect(anchorRef?.current?.getBoundingClientRect());\n\n    const offset = useMemo(\n      () => getOffset(ref, propOffset),\n      [propOffset, Boolean(ref.current)],\n    );\n\n    const { position, direction } = getComputedPositionAndDirection({\n      contentSize: { width, height },\n      viewportSize: {\n        // Размер вьюпорта без скроллбаров\n        width: viewportElement.clientWidth,\n        height: viewportElement.clientHeight,\n      },\n      arrowOffset,\n      offset,\n      direction: passedDirection,\n      possibleDirections,\n      bannedDirections,\n      position: getPointPosition(\n        viewportElement,\n        anchorClientRect\n          ? { x: anchorClientRect.left, y: anchorClientRect.top }\n          : passedPosition,\n        !!viewportRef?.current,\n      ),\n      anchorSize,\n      spareDirection,\n    });\n\n    useEffect(() => onSetDirection?.(direction), [direction]);\n\n    useEffect(updateAnchorClientRect, [anchorSize]);\n\n    usePopoverReposition({\n      isActive: true,\n      scrollAnchorRef: anchorRef || { current: null },\n      onRequestReposition: () => {\n        resetBannedDirections();\n        updateAnchorClientRect();\n      },\n    });\n\n    /**\n     * Может возникнуть ситуация, когда перерасчет поповера всегда будет выдавать 2 направления\n     * и бесконечно зацикливать себя. Для избежания таких кейсов мы запоминаем стороны,\n     * которые не подошли, чтобы не возвращаться к ним и предотвратить бесконечный ререндер.\n     * См. PopoverBannedPositionsStory\n     */\n\n    useLayoutEffect(() => {\n      if (previousDirectionRef.current !== direction) {\n        if (\n          previousDirectionRef.current &&\n          !bannedDirections.includes(previousDirectionRef.current) &&\n          !bannedDirections.includes(direction) &&\n          direction !== spareDirection\n        ) {\n          setBannedDirections((state) =>\n            previousDirectionRef.current\n              ? [...state, previousDirectionRef.current]\n              : state,\n          );\n        }\n        previousDirectionRef.current = direction;\n      }\n    }, [direction]);\n\n    // Сбрасываем при любом изменении пропсов, чтобы заново начать перебор направлений\n    // Главное не сбрасывать при изменении размеров поповера, т.к. именно оно может вызвать бесконечный перебор\n\n    useLayoutEffect(resetBannedDirections, [props]);\n\n    const renderPosition = getRenderPosition(\n      viewportElement,\n      position,\n      !!viewportRef?.current,\n      width,\n      height,\n    );\n\n    const notVisible = !renderPosition || !height || !width;\n\n    return (\n      <PortalWithTheme\n        {...otherProps}\n        preset={theme}\n        className={cnPopover({ direction, notVisible }, [className])}\n        container={container}\n        ref={useForkRef([ref, componentRef])}\n        style={{\n          ...style,\n          ...(notVisible\n            ? {}\n            : {\n                ['--popover-left' as string]: `${renderPosition.x}px`,\n                ['--popover-top' as string]: `${renderPosition.y}px`,\n                [`--popover-width` as string]: equalAnchorWidth\n                  ? `${anchorSize.width}px`\n                  : undefined,\n                [`--popover-pointer-events` as string]: isInteractive\n                  ? undefined\n                  : 'none',\n                [`--popover-visibility` as string]: position\n                  ? undefined\n                  : 'hidden',\n              }),\n        }}\n      >\n        <PortalWithThemeConsumer\n          onClickOutside={onClickOutside}\n          ignoreClicksInsideRefs={[ref, anchorRef || { current: null }]}\n        >\n          {isRenderProp(children) ? children(direction) : children}\n        </PortalWithThemeConsumer>\n      </PortalWithTheme>\n    );\n  },\n);\n"],"mappings":"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"}