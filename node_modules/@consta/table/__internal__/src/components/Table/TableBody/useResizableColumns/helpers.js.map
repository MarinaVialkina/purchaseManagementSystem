{"version":3,"file":"helpers.js","names":["trackPosition","useDebounce","useResizeObserved","useAction","useAtom","useMemo","minMax","min","max","value","Math","sizesEq","newSizes","sizes","join","getContainerWidth","el","floor","clientWidth","offsetWidth","getBoundingClientRect","width","undefined","getRefsSizes","blocks","gap","map","ref","maxWidth","minWidth","current","roundValue","getTargetBlockPosition","index","slice","reduce","val","a","getBlockMaxSizes","block","addResult","result","length","isSizesCalculate","find","item","getSizesSum","b","getValidValues","containerWidth","resizable","currentMinMax","guardValue","results","size","splice","newSizesSum","nextIndex","nextMinMax","nextValue","push","sizesSum","getCalculatedSizes","event","container","position","x","containerLeft","left","scrollLeft","useResizeContainer","containerAtom","blocksAtom","resizableAtom","sizesAtom","set","containerRef","ctx","get","blockMinMax","newSize"],"sources":["../../../../../../../src/components/Table/TableBody/useResizableColumns/helpers.ts"],"sourcesContent":["import { trackPosition } from '@consta/uikit/__internal__/src/components/Slider/useSlider/helper';\nimport { useDebounce } from '@consta/uikit/useDebounce';\nimport { useResizeObserved } from '@consta/uikit/useResizeObserved';\nimport { AtomMut } from '@reatom/core';\nimport { useAction, useAtom } from '@reatom/npm-react';\nimport React, { useMemo } from 'react';\n\nimport { UseResizableColumnsBlock, UseResizableColumnsSize } from './types';\n\nconst minMax = (min?: number, max?: number, value?: number) => {\n  if (typeof value === 'number') {\n    if (max && min) {\n      return Math.min(max, Math.max(min, value));\n    }\n    if (max) {\n      return Math.min(max, value);\n    }\n    if (min) {\n      return Math.max(min, value);\n    }\n    return value;\n  }\n  if (max === min) {\n    return max;\n  }\n  return value;\n};\n\nexport const sizesEq = (\n  newSizes: (string | number | undefined)[],\n  sizes: (string | number | undefined)[],\n) => newSizes.join('-') === sizes.join('-');\n\nconst getContainerWidth = (el?: HTMLElement | null) =>\n  el\n    ? Math.floor(\n        el.clientWidth - (el.offsetWidth - el.getBoundingClientRect().width),\n      )\n    : undefined;\n\nexport const getRefsSizes = (\n  blocks: UseResizableColumnsBlock[],\n): (number | string | undefined)[] => {\n  let gap = 0;\n\n  return blocks.map(({ ref, maxWidth, minWidth, width }) => {\n    const value =\n      minMax(minWidth, maxWidth, ref.current?.getBoundingClientRect().width) ||\n      (typeof width === 'number' ? minMax(minWidth, maxWidth, width) : width);\n\n    if (typeof value === 'number') {\n      const roundValue = Math.floor(value + gap);\n\n      gap += value - roundValue;\n\n      return roundValue;\n    }\n\n    return value;\n  });\n};\n\nconst getTargetBlockPosition = (\n  sizes: UseResizableColumnsSize[],\n  index: number,\n) =>\n  sizes\n    .slice(0, index)\n    .map((el) => (typeof el === 'number' ? el : 0))\n    .reduce((val, a) => (val ?? 0) + (a ?? 0), 0);\n\nconst getBlockMaxSizes = (block: UseResizableColumnsBlock | undefined) => {\n  return [block?.minWidth || 0, block?.maxWidth] as const;\n};\n\ntype GetValidValuesResult = [number, number][];\n\nexport const addResult = <T extends UseResizableColumnsSize>(\n  result: [number, T][],\n  sizes: T[],\n): T[] => {\n  const newSizes = [...sizes];\n  for (let index = 0; index < result.length; index++) {\n    // eslint-disable-next-line prefer-destructuring\n    newSizes[result[index][0]] = result[index][1];\n  }\n\n  return newSizes;\n};\n\nexport const isSizesCalculate = (\n  sizes: (number | string | undefined)[],\n): sizes is number[] =>\n  !sizes.find(\n    (item) => typeof item === 'string' || typeof item === 'undefined',\n  );\n\nexport const getSizesSum = (sizes: number[]) => sizes.reduce((a, b) => a + b);\n\nconst getValidValues = (\n  value: number,\n  index: number,\n  blocks: UseResizableColumnsBlock[],\n  containerWidth: number,\n  sizes: UseResizableColumnsSize[],\n  resizable: 'inside' | 'outside',\n): GetValidValuesResult => {\n  const currentMinMax = getBlockMaxSizes(blocks[index]);\n\n  const guardValue = minMax(currentMinMax[0], currentMinMax[1], value) || 0;\n\n  const results: GetValidValuesResult = [[index, guardValue]];\n\n  const newSizes = [...sizes].map((size) =>\n    typeof size === 'number' ? size : 0,\n  );\n  newSizes.splice(index, 1, guardValue);\n\n  const newSizesSum = getSizesSum(newSizes);\n\n  let nextIndex = blocks.length - 1;\n\n  while (newSizes[nextIndex] && nextIndex > index && resizable === 'inside') {\n    const gap = containerWidth - newSizesSum;\n\n    const nextMinMax = getBlockMaxSizes(blocks[nextIndex]);\n    const nextValue =\n      minMax(nextMinMax[0], nextMinMax[1], newSizes[nextIndex] + gap) || 0;\n\n    if (\n      newSizes[nextIndex] + gap !== nextValue ||\n      nextValue === results[0][1]\n    ) {\n      nextIndex -= 1;\n      continue;\n    }\n\n    results.push([nextIndex, nextValue]);\n\n    if (newSizesSum + gap === containerWidth) {\n      break;\n    }\n\n    nextIndex -= 1;\n  }\n\n  const sizesSum = getSizesSum(addResult(results, newSizes));\n\n  if (resizable === 'inside' && sizesSum !== containerWidth) {\n    return [];\n  }\n\n  if (resizable === 'outside' && sizesSum < containerWidth) {\n    newSizes.splice(index, 1, 0);\n\n    return [[index, containerWidth - getSizesSum(newSizes)]];\n  }\n\n  return results;\n};\n\nexport const getCalculatedSizes = (\n  event: MouseEvent | TouchEvent | Event,\n  index: number,\n  blocks: UseResizableColumnsBlock[],\n  container: React.RefObject<HTMLElement>,\n  sizes: UseResizableColumnsSize[],\n  resizable: 'inside' | 'outside',\n): [number, UseResizableColumnsSize][] => {\n  const position = trackPosition(event as MouseEvent | TouchEvent)?.x;\n\n  if (position) {\n    const containerWidth = getContainerWidth(container.current) || 0;\n    const containerLeft = container.current?.getBoundingClientRect().left || 0;\n    const scrollLeft = container.current?.scrollLeft || 0;\n    const trackPosition = getTargetBlockPosition(sizes, index);\n\n    const value = Math.floor(\n      position + scrollLeft - containerLeft - trackPosition,\n    );\n\n    return getValidValues(\n      value,\n      index,\n      blocks,\n      containerWidth,\n      sizes,\n      resizable,\n    );\n  }\n\n  return [];\n};\n\nexport const useResizeContainer = (\n  containerAtom: AtomMut<React.RefObject<HTMLElement>>,\n  blocksAtom: AtomMut<UseResizableColumnsBlock[]>,\n  resizableAtom: AtomMut<'inside' | 'outside' | undefined>,\n  sizesAtom: AtomMut<(string | number | undefined)[]>,\n  set: (newSizes: (string | number | undefined)[]) => void,\n) => {\n  const [containerRef] = useAtom(containerAtom);\n\n  return useResizeObserved(\n    useMemo(() => [containerRef], [containerRef]),\n    useDebounce(\n      useAction((ctx, el) => {\n        const containerWidth = getContainerWidth(el);\n        const newSizes = [...ctx.get(sizesAtom)];\n        const resizable = ctx.get(resizableAtom);\n\n        if (containerWidth && isSizesCalculate(newSizes)) {\n          const blocks = ctx.get(blocksAtom);\n          const sizesSum = getSizesSum(newSizes);\n          let gap = containerWidth - sizesSum;\n\n          if (\n            (resizable !== 'outside' && gap) ||\n            (resizable === 'outside' && gap > 0)\n          ) {\n            let index = blocks.length - 1;\n\n            while (newSizes[index] && gap) {\n              const blockMinMax = getBlockMaxSizes(blocks[index]);\n              const size = newSizes[index];\n              const newSize =\n                minMax(blockMinMax[0], blockMinMax[1], newSizes[index] + gap) ||\n                0;\n\n              gap -= newSize - size;\n\n              newSizes[index] = newSize;\n\n              index -= 1;\n            }\n          }\n          set(newSizes);\n        }\n      }),\n      10,\n    ),\n  );\n};\n"],"mappings":"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"}