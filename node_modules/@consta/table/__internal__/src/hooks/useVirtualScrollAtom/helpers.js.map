{"version":3,"file":"helpers.js","names":["getElementSize","useEffect","defaultItemsCalculationCount","arraysIsEq","arr1","arr2","join","useScroll","ref","fn","isActive","current","addEventListener","removeEventListener","getElementHeight","el","height","roundPositionByGap","position","gap","Math","ceil","getVisiblePosition","top","elementMaxSize","visiblePosition","calculateSavedSizes","savedSizes","sizes","newSavedSizes","index","length","element","addCount","pxs","savedSize","lastSavedSize","slice","average","reduce","a","b","add","calculateBounds","indexs"],"sources":["../../../../../src/hooks/useVirtualScrollAtom/helpers.ts"],"sourcesContent":["import { getElementSize } from '@consta/uikit/useResizeObserved';\nimport { AtomMut } from '@reatom/core';\nimport { RefObject, useEffect } from 'react';\n\nexport type UseVirtualScrollProps = {\n  length: number;\n  isActive?: boolean;\n  onScrollToBottom?: (index: number) => void;\n};\n\nexport type UseVirtualScrollReturn<ITEM_ELEMENT, SCROLL_ELEMENT> = {\n  listRefsAtom: AtomMut<React.RefObject<ITEM_ELEMENT>[]>;\n  scrollElementRef: React.RefObject<SCROLL_ELEMENT>;\n  sliceAtom: AtomMut<[number, number]>;\n  spaceTopAtom: AtomMut<number>;\n};\n\nexport type Bounds = [[number, number], [number, number]];\n\nexport const defaultItemsCalculationCount = 1;\n\nexport const arraysIsEq = (arr1: number[], arr2: number[]) =>\n  arr1.join('-') === arr2.join('-');\n\nexport const useScroll = (\n  ref: RefObject<HTMLElement>,\n  fn: () => void,\n  isActive: boolean,\n) => {\n  useEffect(() => {\n    if (isActive) {\n      ref.current?.addEventListener('scroll', fn);\n    }\n\n    return () => {\n      ref.current?.removeEventListener('scroll', fn);\n    };\n  }, [ref.current, fn, isActive]);\n};\n\nexport const getElementHeight = (el: HTMLElement | SVGGraphicsElement | null) =>\n  getElementSize(el).height;\n\nconst roundPositionByGap = (position: number, gap: number) => {\n  if (position <= 0) {\n    return 0;\n  }\n  return Math.ceil(position / gap) * gap;\n};\n\nexport const getVisiblePosition = (\n  top: number,\n  height: number,\n  elementMaxSize: number,\n): [number, number] => {\n  const gap =\n    height > elementMaxSize * defaultItemsCalculationCount\n      ? height\n      : elementMaxSize * defaultItemsCalculationCount;\n\n  const visiblePosition: [number, number] = [\n    Math.ceil(\n      roundPositionByGap(\n        height < gap ? top - (gap + height) : top - (gap + height / 2),\n        height,\n      ),\n    ),\n    Math.ceil(roundPositionByGap(top === 0 ? gap : top + gap * 1.25, height)),\n  ];\n\n  return visiblePosition;\n};\n\nexport const calculateSavedSizes = (savedSizes: number[], sizes: number[]) => {\n  const newSavedSizes = [...savedSizes];\n  for (let index = 0; index < sizes.length; index++) {\n    const element = sizes[index];\n    if (element > 0) {\n      newSavedSizes[index] = element;\n    }\n  }\n  return newSavedSizes;\n};\n\nconst addCount = (\n  pxs: [number, number],\n  visiblePosition: [number, number],\n  savedSize: number[],\n) => {\n  const lastSavedSize = savedSize.slice(-50);\n  const average =\n    lastSavedSize.reduce((a, b) => a + b, 0) / lastSavedSize.length;\n\n  let add = 0;\n\n  if (visiblePosition[1] < pxs[1] + add * average) {\n    return add;\n  }\n\n  while (visiblePosition[1] > pxs[1] + add * average) {\n    add += defaultItemsCalculationCount;\n  }\n\n  return add;\n};\n\nexport const calculateBounds = (\n  savedSizes: number[],\n  sizes: number[],\n  visiblePosition: [number, number],\n  length: number,\n): Bounds => {\n  const pxs: [number, number] = [0, 0];\n  const indexs: [number, number] = [0, 0];\n\n  for (let index = 0; index < savedSizes.length; index++) {\n    if (visiblePosition[0] > pxs[0]) {\n      pxs[0] += savedSizes[index];\n      indexs[0] = index + 1;\n    }\n\n    if (visiblePosition[1] > pxs[1]) {\n      pxs[1] += savedSizes[index];\n      indexs[1] = index + 1;\n    }\n  }\n\n  if (indexs[0] === 0 && indexs[1] === 0) {\n    indexs[1] = defaultItemsCalculationCount;\n  }\n\n  if (sizes.length !== savedSizes.length) {\n    indexs[1] += addCount(pxs, visiblePosition, savedSizes);\n  }\n\n  if (indexs[1] > length) {\n    indexs[1] = length;\n  }\n\n  return [pxs, indexs];\n};\n"],"mappings":"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"}