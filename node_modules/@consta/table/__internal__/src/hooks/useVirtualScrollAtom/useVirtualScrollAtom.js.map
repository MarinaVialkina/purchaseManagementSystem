{"version":3,"file":"useVirtualScrollAtom.js","names":["objectWithDefault","useCreateAtom","usePropAtom","useSendToAtom","useAction","useAtom","useUpdate","createRef","useMemo","useRef","useResizeObservedAtom","arraysIsEq","calculateBounds","calculateSavedSizes","defaultItemsCalculationCount","getElementHeight","getVisiblePosition","useScroll","visiblePositionInitial","useVirtualScrollAtom","props","propsWithDefault","isActive","propsAtom","lengthAtom","isActiveAtom","onScrollToBottomAtom","visiblePositionAtom","boundsAtom","length","setBoundsAction","ctx","value","currentValue","get","sliceStartAtom","spy","sliceEndAtom","sliceEnd","sliceAtom","spaceTopAtom","listRefsAtom","Array","fill","map","scrollElementRef","sizesAtom","savedSizesAtom","scrollElementRefHeightArrayAtom","scrollElementRefHeightAtom","calculateVisiblePosition","scrollElement","current","elementMaxSize","Math","max","apply","visiblePosition","scrollTop","state","sizes","savedSizes","newSavedSizes","slice","onScrollToBottom","bounds","resetVisiblePosition","resetBounds"],"sources":["../../../../../src/hooks/useVirtualScrollAtom/useVirtualScrollAtom.ts"],"sourcesContent":["import { objectWithDefault } from '@consta/uikit/__internal__/src/utils/object/objectWithDefault';\nimport { useCreateAtom } from '@consta/uikit/__internal__/src/utils/state/useCreateAtom';\nimport { usePropAtom } from '@consta/uikit/__internal__/src/utils/state/usePickAtom';\nimport { useSendToAtom } from '@consta/uikit/__internal__/src/utils/state/useSendToAtom';\nimport { useAction, useAtom, useUpdate } from '@reatom/npm-react';\nimport { createRef, useMemo, useRef } from 'react';\n\nimport { useResizeObservedAtom } from '../useResizeObservedAtom';\nimport {\n  arraysIsEq,\n  Bounds,\n  calculateBounds,\n  calculateSavedSizes,\n  defaultItemsCalculationCount,\n  getElementHeight,\n  getVisiblePosition,\n  useScroll,\n  UseVirtualScrollProps,\n  UseVirtualScrollReturn,\n} from './helpers';\n\nconst visiblePositionInitial: [number, number] = [0, 0];\n\nexport const useVirtualScrollAtom = <\n  ITEM_ELEMENT extends HTMLElement = HTMLDivElement,\n  SCROLL_ELEMENT extends HTMLElement = HTMLDivElement,\n>(\n  props: UseVirtualScrollProps,\n): UseVirtualScrollReturn<ITEM_ELEMENT, SCROLL_ELEMENT> => {\n  const propsWithDefault = objectWithDefault({ isActive: false }, props);\n  const propsAtom = useSendToAtom(propsWithDefault);\n  const lengthAtom = usePropAtom(propsAtom, 'length');\n  const isActiveAtom = usePropAtom(propsAtom, 'isActive');\n  const onScrollToBottomAtom = usePropAtom(propsAtom, 'onScrollToBottom');\n\n  const visiblePositionAtom = useCreateAtom(visiblePositionInitial);\n\n  const boundsAtom = useCreateAtom<Bounds>([\n    [0, 0],\n    [\n      0,\n      propsWithDefault.isActive\n        ? defaultItemsCalculationCount\n        : propsWithDefault.length,\n    ],\n  ]);\n\n  const setBoundsAction = useAction((ctx, value: Bounds) => {\n    const currentValue = ctx.get(boundsAtom);\n    if (\n      !arraysIsEq(currentValue[0], value[0]) ||\n      !arraysIsEq(currentValue[1], value[1])\n    ) {\n      boundsAtom(ctx, value);\n    }\n  });\n\n  const sliceStartAtom = useCreateAtom((ctx) => ctx.spy(boundsAtom)[1][0]);\n  const sliceEndAtom = useCreateAtom((ctx) => {\n    const sliceEnd = ctx.spy(boundsAtom)[1][1];\n    return sliceEnd < 50 ? 50 : sliceEnd;\n  });\n  const sliceAtom = useCreateAtom<[number, number]>((ctx) => [\n    ctx.spy(sliceStartAtom),\n    ctx.spy(sliceEndAtom),\n  ]);\n\n  const spaceTopAtom = useCreateAtom((ctx) => ctx.spy(boundsAtom)[0][0]);\n\n  const listRefsAtom = useCreateAtom((ctx) => {\n    const length = ctx.spy(lengthAtom);\n    ctx.spy(visiblePositionAtom);\n    return new Array(length).fill(null).map(createRef<ITEM_ELEMENT>);\n  });\n\n  const scrollElementRef = useRef<SCROLL_ELEMENT>(null);\n  const sizesAtom = useResizeObservedAtom(\n    useAtom(listRefsAtom)[0],\n    getElementHeight,\n  );\n\n  const savedSizesAtom = useCreateAtom<number[]>([]);\n\n  const scrollElementRefHeightArrayAtom = useResizeObservedAtom(\n    useMemo(() => {\n      return [scrollElementRef];\n    }, [scrollElementRef]),\n    getElementHeight,\n  );\n\n  const scrollElementRefHeightAtom = useCreateAtom((ctx) => {\n    return ctx.spy(scrollElementRefHeightArrayAtom)[0];\n  });\n\n  const calculateVisiblePosition = useAction((ctx) => {\n    const scrollElement = scrollElementRef.current;\n    if (!scrollElement) {\n      return;\n    }\n\n    const elementMaxSize = Math.max.apply(null, ctx.get(sizesAtom));\n\n    const visiblePosition = getVisiblePosition(\n      scrollElement.scrollTop,\n      getElementHeight(scrollElement),\n      elementMaxSize,\n    );\n\n    const state = ctx.get(visiblePositionAtom);\n    if (visiblePosition[0] !== state[0] || visiblePosition[1] !== state[1]) {\n      visiblePositionAtom(ctx, visiblePosition);\n    }\n  });\n\n  useScroll(\n    scrollElementRef,\n    calculateVisiblePosition,\n    propsWithDefault.isActive,\n  );\n\n  useUpdate(calculateVisiblePosition, [\n    scrollElementRefHeightAtom,\n    isActiveAtom,\n  ]);\n\n  useUpdate(\n    (ctx, visiblePosition, sizes, length, isActive) => {\n      if (isActive) {\n        const savedSizes = ctx.get(savedSizesAtom);\n        const newSavedSizes = calculateSavedSizes(savedSizes, sizes);\n\n        savedSizesAtom(ctx, newSavedSizes);\n\n        setBoundsAction(\n          calculateBounds(newSavedSizes, sizes, visiblePosition, length),\n        );\n      } else {\n        const state = ctx.get(boundsAtom);\n        if (\n          state[0][0] !== 0 ||\n          state[0][1] !== 0 ||\n          state[1][0] !== 0 ||\n          state[1][1] !== length\n        ) {\n          setBoundsAction([\n            [0, 0],\n            [0, length],\n          ]);\n        }\n      }\n    },\n    [visiblePositionAtom, sizesAtom, lengthAtom, isActiveAtom],\n  );\n\n  useUpdate(\n    (ctx, slice) => {\n      const length = ctx.get(lengthAtom);\n      const onScrollToBottom = ctx.get(onScrollToBottomAtom);\n      if (onScrollToBottom && slice >= length) {\n        onScrollToBottom(length);\n      }\n    },\n    [sliceEndAtom],\n  );\n\n  useUpdate(\n    (ctx, isActive) => {\n      const length = ctx.get(lengthAtom);\n      const bounds = ctx.get(boundsAtom);\n      const visiblePosition = ctx.get(visiblePositionAtom);\n      const resetVisiblePosition: [number, number] = [0, 0];\n      const resetBounds: Bounds = [\n        [0, 0],\n        [0, isActive ? defaultItemsCalculationCount : length],\n      ];\n\n      if (\n        !(\n          arraysIsEq(bounds[0], resetBounds[0]) &&\n          arraysIsEq(bounds[1], resetBounds[1])\n        )\n      ) {\n        boundsAtom(ctx, resetBounds);\n      }\n\n      if (!arraysIsEq(visiblePosition, resetVisiblePosition)) {\n        visiblePositionAtom(ctx, resetVisiblePosition);\n      }\n    },\n    [isActiveAtom],\n  );\n\n  return {\n    listRefsAtom,\n    scrollElementRef,\n    sliceAtom,\n    spaceTopAtom,\n  };\n};\n"],"mappings":"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"}